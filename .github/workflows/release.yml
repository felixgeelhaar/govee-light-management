name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run type checking
      run: npm run type-check
    
    - name: Run linting
      run: npm run lint
    
    - name: Run tests
      run: npm test
    
    - name: Run build
      run: npm run build
    
    - name: Validate plugin structure
      run: npx streamdeck validate com.felixgeelhaar.govee-light-management.sdPlugin

  build:
    name: Build Plugin
    runs-on: ${{ matrix.os }}
    needs: test
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build plugin
      run: npm run build
    
    - name: Create plugin package
      run: npx streamdeck pack com.felixgeelhaar.govee-light-management.sdPlugin -o govee-light-management-${{ matrix.os }}.streamDeckPlugin
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: plugin-${{ matrix.os }}
        path: "*.streamDeckPlugin"

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build plugin
      run: npm run build
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Create universal plugin package
      run: npx streamdeck pack com.felixgeelhaar.govee-light-management.sdPlugin -o govee-light-management.streamDeckPlugin
    
    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Generate release notes
      id: generate_notes
      run: |
        # Get the previous tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^)
        
        # Generate changelog
        echo "## 🚀 What's New in v${{ steps.get_version.outputs.VERSION }}" > release_notes.md
        echo "" >> release_notes.md
        
        # Get commits since last tag
        git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --grep="feat:" --grep="fix:" --grep="perf:" --grep="refactor:" >> release_notes.md
        echo "" >> release_notes.md
        echo "" >> release_notes.md
        
        # Add installation instructions
        echo "## 📦 Installation" >> release_notes.md
        echo "" >> release_notes.md
        echo "### Option 1: Download Plugin Package" >> release_notes.md
        echo "1. Download \`govee-light-management.streamDeckPlugin\` from the assets below" >> release_notes.md
        echo "2. Double-click the file to install in Stream Deck" >> release_notes.md
        echo "" >> release_notes.md
        echo "### Option 2: Platform-Specific Packages" >> release_notes.md
        echo "- **macOS**: \`govee-light-management-macos-latest.streamDeckPlugin\`" >> release_notes.md
        echo "- **Windows**: \`govee-light-management-windows-latest.streamDeckPlugin\`" >> release_notes.md
        echo "- **Linux**: \`govee-light-management-ubuntu-latest.streamDeckPlugin\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## 🔧 Requirements" >> release_notes.md
        echo "- Stream Deck Software v6.0 or later" >> release_notes.md
        echo "- Node.js v18.0 or later (for development)" >> release_notes.md
        echo "- Govee API Key from [developer.govee.com](https://developer.govee.com)" >> release_notes.md
        echo "" >> release_notes.md
        echo "## 📚 Documentation" >> release_notes.md
        echo "- [Installation Guide](https://github.com/felixgeelhaar/govee-light-management#installation)" >> release_notes.md
        echo "- [Usage Instructions](https://github.com/felixgeelhaar/govee-light-management#usage)" >> release_notes.md
        echo "- [Contributing Guide](https://github.com/felixgeelhaar/govee-light-management/blob/main/CONTRIBUTING.md)" >> release_notes.md
        echo "" >> release_notes.md
        echo "## 🏪 Elgato Marketplace Submission" >> release_notes.md
        echo "" >> release_notes.md
        echo "To submit this plugin to the Elgato Marketplace:" >> release_notes.md
        echo "1. Download the \`marketplace-submission\` artifact from the workflow run" >> release_notes.md
        echo "2. Follow the instructions in \`SUBMISSION_CHECKLIST.md\`" >> release_notes.md
        echo "3. Submit via [Elgato Maker Console](https://marketplace.elgato.com/)" >> release_notes.md
        echo "" >> release_notes.md
        echo "For detailed submission instructions, see [MARKETPLACE_SUBMISSION.md](https://github.com/felixgeelhaar/govee-light-management/blob/main/MARKETPLACE_SUBMISSION.md)" >> release_notes.md
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: "Release v${{ steps.get_version.outputs.VERSION }}"
        body_path: release_notes.md
        files: |
          govee-light-management.streamDeckPlugin
          plugin-*/govee-light-management-*.streamDeckPlugin
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  marketplace-prep:
    name: Marketplace Preparation
    runs-on: ubuntu-latest
    needs: release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build plugin
      run: npm run build
    
    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Validate plugin for marketplace
      run: |
        echo "🔍 Validating plugin for marketplace submission..."
        npx streamdeck validate com.felixgeelhaar.govee-light-management.sdPlugin
    
    - name: Check required assets
      run: |
        echo "📋 Checking required marketplace assets..."
        # Check for required icon sizes
        if [ ! -f "com.felixgeelhaar.govee-light-management.sdPlugin/assets/icon.png" ]; then
          echo "❌ Missing icon.png"
          exit 1
        fi
        if [ ! -f "com.felixgeelhaar.govee-light-management.sdPlugin/assets/icon@2x.png" ]; then
          echo "❌ Missing icon@2x.png"
          exit 1
        fi
        echo "✅ All required assets found"
    
    - name: Generate marketplace metadata
      run: |
        cat > marketplace-metadata.json << EOF
        {
          "name": "Govee Light Management",
          "version": "${{ steps.get_version.outputs.VERSION }}",
          "description": "Enterprise-grade Stream Deck plugin for managing Govee smart lights with advanced group functionality",
          "category": ["Smart Home", "Lighting"],
          "tags": ["govee", "smart-lights", "automation", "iot"],
          "requirements": {
            "streamDeck": "6.0.0",
            "os": ["windows", "macos"]
          },
          "author": "Felix Geelhaar",
          "support": "https://github.com/felixgeelhaar/govee-light-management/issues",
          "documentation": "https://github.com/felixgeelhaar/govee-light-management#readme"
        }
        EOF
        echo "📄 Generated marketplace metadata"
    
    - name: Create submission package
      run: |
        mkdir -p marketplace-submission
        npx streamdeck pack com.felixgeelhaar.govee-light-management.sdPlugin -o marketplace-submission/govee-light-management.streamDeckPlugin
        cp marketplace-metadata.json marketplace-submission/
        cp README.md marketplace-submission/
        cp LICENSE marketplace-submission/
        
        # Create submission checklist
        cat > marketplace-submission/SUBMISSION_CHECKLIST.md << EOF
        # Elgato Marketplace Submission Checklist
        
        Plugin: Govee Light Management v${{ steps.get_version.outputs.VERSION }}
        
        ## Pre-submission Requirements ✅
        - [x] Plugin validated with streamdeck validate
        - [x] All required icon sizes present
        - [x] Plugin tested on Windows and macOS
        - [x] README.md updated with latest features
        - [x] LICENSE file included
        
        ## Manual Submission Steps
        
        1. **Access Maker Console**
           - Go to: https://marketplace.elgato.com/
           - Sign in as a Maker
        
        2. **Submit Plugin Package**
           - Upload: \`govee-light-management.streamDeckPlugin\`
           - Category: Smart Home > Lighting
           - Tags: govee, smart-lights, automation, iot
        
        3. **Provide Description**
           - Use content from marketplace-metadata.json
           - Highlight key features:
             - Individual light control
             - Group management
             - Advanced color and brightness control
             - Real-time state monitoring
        
        4. **Add Screenshots**
           - Property Inspector view
           - Stream Deck button states
           - Group management interface
        
        5. **Testing Information**
           - Requires Govee API key
           - Compatible with all Govee smart lights
           - Tested on Stream Deck, Stream Deck XL, Stream Deck Mini
        
        6. **Support Information**
           - GitHub Issues: https://github.com/felixgeelhaar/govee-light-management/issues
           - Documentation: https://github.com/felixgeelhaar/govee-light-management#readme
        
        ## Post-submission
        - [ ] Monitor Maker Console for review feedback
        - [ ] Join Marketplace Maker Discord for beta testing
        - [ ] Prepare marketing materials
        EOF
        
        echo "📦 Marketplace submission package created"
    
    - name: Upload marketplace package
      uses: actions/upload-artifact@v4
      with:
        name: marketplace-submission
        path: marketplace-submission/

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: release
    if: always()
    
    steps:
    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Notify Discord (if configured)
      if: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        curl -H "Content-Type: application/json" \
             -d "{\"content\": \"🚀 **Govee Light Management v${{ steps.get_version.outputs.VERSION }}** has been released!\n\n📦 Download: https://github.com/felixgeelhaar/govee-light-management/releases/tag/v${{ steps.get_version.outputs.VERSION }}\n📚 Docs: https://github.com/felixgeelhaar/govee-light-management#readme\"}" \
             ${{ secrets.DISCORD_WEBHOOK }}
      continue-on-error: true