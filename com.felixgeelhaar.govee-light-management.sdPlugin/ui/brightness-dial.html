<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Brightness Dial Settings</title>
    <link rel="stylesheet" href="css/sdpi.css">
    <script src="js/property-inspector.js"></script>
</head>
<body>
    <div class="sdpi-wrapper">
        <div class="sdpi-heading">Configuration</div>
        
        <div class="sdpi-item">
            <div class="sdpi-item-label">API Key</div>
            <input class="sdpi-item-value" type="password" id="apiKey" placeholder="Enter your Govee API key">
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Select Light</div>
            <select class="sdpi-item-value select" id="selectedDeviceId">
                <option value="">Loading devices...</option>
            </select>
        </div>

        <div class="sdpi-heading">Dial Settings</div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Min Brightness</div>
            <div class="sdpi-item-value">
                <input type="range" min="0" max="100" value="0" id="minBrightness">
                <span class="clickable" id="minBrightnessValue">0%</span>
            </div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Max Brightness</div>
            <div class="sdpi-item-value">
                <input type="range" min="0" max="100" value="100" id="maxBrightness">
                <span class="clickable" id="maxBrightnessValue">100%</span>
            </div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Step Size</div>
            <div class="sdpi-item-value">
                <input type="range" min="1" max="20" value="5" id="stepSize">
                <span class="clickable" id="stepSizeValue">5</span>
            </div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Instructions</div>
            <div class="sdpi-item-value">
                <details class="message">
                    <summary>How to use the Brightness Dial</summary>
                    <ul>
                        <li><strong>Rotate:</strong> Adjust brightness</li>
                        <li><strong>Press:</strong> Toggle light on/off</li>
                        <li><strong>Long Touch:</strong> Reset to 50%</li>
                        <li><strong>Press + Rotate:</strong> 2x speed adjustment</li>
                    </ul>
                </details>
            </div>
        </div>
    </div>

    <script>
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Update range value displays
            ['minBrightness', 'maxBrightness', 'stepSize'].forEach(id => {
                const input = document.getElementById(id);
                const display = document.getElementById(id + 'Value');
                
                input.addEventListener('input', function() {
                    if (id === 'stepSize') {
                        display.textContent = this.value;
                    } else {
                        display.textContent = this.value + '%';
                    }
                    saveSettings();
                });
            });

            // Handle API key change
            document.getElementById('apiKey').addEventListener('change', function() {
                saveSettings();
                if (this.value) {
                    loadDevices();
                }
            });

            // Handle device selection
            document.getElementById('selectedDeviceId').addEventListener('change', function() {
                const option = this.options[this.selectedIndex];
                if (option && option.value) {
                    saveSettings({
                        selectedModel: option.dataset.model,
                        selectedLightName: option.textContent
                    });
                }
            });
        });

        // Load devices from plugin
        function loadDevices() {
            if (window.$SD) {
                window.$SD.sendToPlugin({ event: 'getDevices' });
            }
        }

        // Handle device list from plugin
        window.onDevicesReceived = function(devices) {
            const select = document.getElementById('selectedDeviceId');
            select.innerHTML = '<option value="">Choose a light...</option>';
            
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.dataset.model = device.model;
                option.textContent = device.name;
                if (!device.isOnline) {
                    option.textContent += ' (Offline)';
                    option.disabled = true;
                }
                select.appendChild(option);
            });
        };

        // Save settings helper
        function saveSettings(additionalSettings = {}) {
            if (window.$SD) {
                const settings = {
                    apiKey: document.getElementById('apiKey').value,
                    selectedDeviceId: document.getElementById('selectedDeviceId').value,
                    minBrightness: parseInt(document.getElementById('minBrightness').value),
                    maxBrightness: parseInt(document.getElementById('maxBrightness').value),
                    stepSize: parseInt(document.getElementById('stepSize').value),
                    ...additionalSettings
                };
                window.$SD.setSettings(settings);
            }
        }
    </script>
</body>
</html>